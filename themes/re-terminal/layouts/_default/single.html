{{ define "main" }}
<article class="post">
  <h1 class="post-title">
    <a href="{{ .Permalink }}">{{ .Title | markdownify }}</a>
  </h1>
  <div class="post-meta">
    {{- if .Date -}}
      <time class="post-date">
        {{- .Date.Format "2006-01-02" -}}
        {{- if $.Site.Params.showLastUpdated -}}
          [{{- or $.Site.Params.updatedDatePrefix "Updated" -}} :: {{- .Lastmod.Format "2006-01-02" -}}]
        {{- end -}}
      </time>
    {{- end -}}
    {{- with .Params.Author -}}
      <span class="post-author">{{ . }}</span>
    {{- end -}}
    <!-- comments counter -->
    {{ partial "comments_counter.html" . }}
    {{- if and (.Param "readingTime") (eq (.Param "readingTime") true) -}}
      <span class="post-reading-time">{{ .ReadingTime }} {{ $.Site.Params.minuteReadingTime | default "min read" }} ({{ .WordCount }} {{ $.Site.Params.words | default "words" }})</span>
    {{- end -}}
  </div>

  {{ if .Params.tags }}
    <span class="post-tags">
      {{ range .Params.tags }}
      #<a href="{{ (urls.JoinPath "tags" (urlize .) "/") | absLangURL }}">{{ . }}</a>&nbsp;
      {{ end }}
    </span>
  {{ end }}
  {{ partial "cover.html" (dict "ctx" . "isCoverCaptionEnabled" true) }}

  {{ if (.Params.Toc | default .Site.Params.Toc) }}
    {{ $tocContent := .TableOfContents }}
    {{ if ne (trim $tocContent " ") "<nav id=\"TableOfContents\"></nav>" }}
      <div class="table-of-contents">
        <h2>
          {{ (.Params.TocTitle | default .Site.Params.TocTitle) | default "Table of Contents" }}
        </h2>
        {{ $tocContent }}
      </div>
    {{ end }}
  {{ end }}

  <div class="post-content">
    {{- with .Content -}}
      <div>
        {{ . | replaceRE "(<h[1-9] id=\"([^\"]+)\".+)(</h[1-9]+>)" `${1}<a href="#${2}" class="hanchor" ariaLabel="Anchor">&#8983;</a> ${3}` | safeHTML }}
      </div>
    {{- end -}}
  </div>

  {{ if eq .Type $.Site.Params.contentTypeName }}
    {{ partial "posts_pagination.html" . }}
  {{ end }}

  {{ if not (.Params.hideComments | default false) }}
    {{ partial "comments.html" . }}
  {{ end }}
</article>
<script>
  function layoutToc() {
    if(document.documentElement.clientWidth >= 685) {
      const content = document.querySelector('.container.center.headings--one-size')
      if(content) {
        const client = content.getBoundingClientRect();
        const left = Math.ceil(client.left + content.offsetWidth - 35);
        const toc = document.querySelector('.table-of-contents');
        const overflowWidth = content.scrollWidth - content.offsetWidth;
        if(overflowWidth > 1) {
          content.style.marginRight = `${document.documentElement.clientWidth - left + overflowWidth - 3}px`;
        }
        if(toc) {
          toc.style.left = `${left}px`;
        }
      }
    }
  }

  window.onresize = layoutToc
  layoutToc()
  document.querySelectorAll('a[href^="#"]').forEach(link => {
    link.onclick = function (e) {
      e.preventDefault();
      const id = decodeURIComponent(this.hash.slice(1))
      document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
    }
  });
</script>
{{ end }}
